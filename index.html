<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Anomaly Auditor | Crafted by 勝全</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f1f5f9;
            color: #0f172a;
        }

        .metric-font { font-family: 'JetBrains Mono', monospace; }

        .card-main {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 1.25rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04);
        }

        .upload-zone {
            position: relative;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px dashed #cbd5e1;
        }
        .upload-zone:hover { border-color: #3b82f6; background-color: #f8fafc; }
        .upload-zone.success { border-style: solid; border-color: #10b981; background-color: #f0fdf4; }
        .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; z-index: 20; }

        .ranking-item {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 8px solid transparent;
        }
        .ranking-item:hover { background-color: #f8fafc; transform: scale(1.01); }
        .ranking-item.active { background-color: #f0f7ff; border-left-color: #2563eb; box-shadow: inset 0 0 0 1px #dbeafe; }
        .ranking-item.is-anomaly { border-left-color: #dc2626; background-color: #fff1f2; }

        .scroll-style::-webkit-scrollbar { width: 8px; }
        .scroll-style::-webkit-scrollbar-track { background: #f1f5f9; }
        .scroll-style::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .time-match-highlight { background-color: #fefce8 !important; border-left: 4px solid #eab308; }
        .text-huge { font-size: 3rem; line-height: 1; }
        
        .btn-analyze {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
        .btn-analyze:disabled { background: #94a3b8; transform: none; cursor: not-allowed; }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #cbd5e1; transition: .4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(20px); }

        .filter-chip {
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
            background: white;
            color: #64748b;
            white-space: nowrap;
        }
        .filter-chip.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* 搜尋高亮 */
        .highlight-text {
            background-color: #fde047; /* 黃色高亮 */
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-[1850px] mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6 bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-6">
                <div class="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center text-white">
                    <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tight text-slate-800">產能效率異常追蹤</h1>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="px-3 py-1 bg-amber-100 text-amber-700 text-xs font-black rounded-full uppercase">Professional Edition</span>
                        <div class="h-4 w-[1px] bg-slate-200"></div>
                        <p class="text-slate-500 font-bold text-base">時間精準配對模式</p>
                    </div>
                </div>
            </div>
            <div class="bg-slate-50 px-10 py-4 rounded-2xl border border-slate-200 flex flex-col items-center">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-1">System Origin</span>
                <span class="text-2xl font-black text-slate-800 tracking-tight">Crafted by 勝全 · Powered by AI</span>
            </div>
        </header>

        <!-- Control Center (Uploads) -->
        <section class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <div id="zoneEff" class="upload-zone card-main p-6 flex items-center gap-5">
                <input type="file" id="fileEff" onchange="handleFileUpload('eff')">
                <div id="iconEff" class="w-12 h-12 rounded-xl bg-blue-50 flex items-center justify-center text-blue-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-width="2"/></svg>
                </div>
                <div class="flex-grow">
                    <h3 class="text-sm font-black text-slate-400 uppercase">Step 1</h3>
                    <p id="labelEff" class="text-base font-bold text-slate-700 truncate">點擊上傳"在製生產統計清單"</p>
                </div>
            </div>

            <div id="zoneHist" class="upload-zone card-main p-6 flex items-center gap-5">
                <input type="file" id="fileHist" onchange="handleFileUpload('hist')">
                <div id="iconHist" class="w-12 h-12 rounded-xl bg-indigo-50 flex items-center justify-center text-indigo-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-width="2"/></svg>
                </div>
                <div class="flex-grow">
                    <h3 class="text-sm font-black text-slate-400 uppercase">Step 2</h3>
                    <p id="labelHist" class="text-base font-bold text-slate-700 truncate">點擊上傳"生產批入出站紀錄"</p>
                </div>
            </div>

            <button id="btnAnalyze" onclick="startAnalysis()" disabled class="btn-analyze rounded-2xl flex items-center justify-center gap-3 text-white font-black text-xl shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-width="2"/></svg>
                開始分析數據
            </button>
        </section>

        <!-- Main Workspace -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: List & Filters -->
            <aside class="lg:col-span-4 flex flex-col h-[850px]">
                <div class="card-main flex flex-col h-full overflow-hidden">
                    <div class="p-6 bg-slate-50 border-b border-slate-200 space-y-4">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-black text-slate-700 italic">異常追蹤與全域篩選</h2>
                            <div class="flex items-center gap-2">
                                 <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                                 <span class="text-xs font-bold text-slate-400">排除組裝</span>
                            </div>
                        </div>

                        <!-- 1. Date Multi-Select -->
                        <div id="dateFilterSection" class="hidden border-b border-slate-200 pb-3">
                            <span class="text-[10px] font-black text-slate-400 uppercase mb-2 block">1. 選擇生產日期 (多選)</span>
                            <div id="dateChips" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto scroll-style pb-1"></div>
                        </div>

                        <!-- 2. Global Operator Search -->
                        <div id="opFilterSection" class="hidden border-b border-slate-200 pb-3">
                            <span class="text-[10px] font-black text-slate-400 uppercase mb-2 block">2. 鎖定操作員 (跨工單搜尋)</span>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" stroke-width="2"/></svg>
                                </span>
                                <input 
                                    type="text" 
                                    id="globalOpSearch" 
                                    onkeyup="renderRankingList()"
                                    placeholder="輸入操作員姓名..." 
                                    class="w-full bg-white border border-slate-200 rounded-lg py-2 pl-9 pr-4 text-xs font-bold outline-none focus:ring-2 focus:ring-blue-500/20"
                                >
                            </div>
                        </div>

                        <!-- 3. General Search -->
                        <div class="relative">
                            <span class="text-[10px] font-black text-slate-400 uppercase mb-2 block">3. 關鍵字搜尋</span>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-width="2"/></svg>
                                </span>
                                <input 
                                    type="text" 
                                    id="searchInput" 
                                    onkeyup="renderRankingList()"
                                    placeholder="工單、產品編號..." 
                                    class="search-input w-full bg-white border border-slate-200 rounded-xl py-2 pl-10 pr-4 text-sm font-bold outline-none"
                                >
                            </div>
                        </div>
                    </div>
                    
                    <div id="rankingList" class="flex-grow overflow-y-auto scroll-style p-5 space-y-4">
                        <div class="flex flex-col items-center justify-center h-full opacity-30 text-center">
                            <p class="text-xl font-black">等待檔案上傳並點擊分析</p>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Right: Details -->
            <section class="lg:col-span-8 flex flex-col gap-8">
                <!-- Record Hero -->
                <div id="auditHeader" class="card-main p-8 border-l-[16px] border-slate-200 opacity-30 transition-all duration-500">
                    <div class="flex flex-col xl:flex-row justify-between items-start gap-8">
                        <div class="space-y-4 flex-grow">
                            <div class="flex items-center gap-3">
                                <span class="bg-slate-900 text-white text-xs font-black px-4 py-1.5 rounded-lg tracking-widest">工單編號</span>
                                <h2 id="activeWO" class="text-5xl font-black metric-font text-slate-900">--</h2>
                            </div>
                            <div class="space-y-1">
                                <h3 id="activeProd" class="text-2xl font-black text-slate-800">選取左側工單開始稽核</h3>
                                <div class="flex items-center gap-2">
                                    <span id="activeProdID" class="text-lg font-black text-blue-600/70 metric-font">--</span>
                                </div>
                            </div>
                            <!-- 恢復的時間比對區塊 -->
                            <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-slate-100">
                                <div class="bg-blue-50/50 p-3 rounded-xl border border-blue-100">
                                    <span class="text-[10px] font-black text-blue-400 uppercase block mb-1">實際生產時間 (進站基準)</span>
                                    <span id="targetStartTime" class="text-sm font-bold text-blue-700 metric-font">--</span>
                                </div>
                                <div class="bg-orange-50/50 p-3 rounded-xl border border-orange-100">
                                    <span class="text-[10px] font-black text-orange-400 uppercase block mb-1">實際完成時間 (出站基準)</span>
                                    <span id="targetFinishTime" class="text-sm font-bold text-orange-700 metric-font">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-3xl shadow-inner border border-slate-100 min-w-[200px] text-center">
                            <p class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Efficiency Rating</p>
                            <div id="activeEff" class="text-huge font-black metric-font text-slate-300">--%</div>
                        </div>
                    </div>
                </div>

                <!-- History Context -->
                <div class="card-main flex flex-col h-[550px] overflow-hidden">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/40">
                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-width="2"/></svg>
                                </div>
                                <h3 class="text-xl font-black text-slate-800 tracking-tight">履歷時間軸比對</h3>
                            </div>
                            
                            <div class="flex items-center gap-4 bg-white px-5 py-2.5 rounded-2xl border border-slate-200 shadow-sm">
                                <span class="text-sm font-black text-slate-600 leading-tight">僅顯示時間吻合</span>
                                <label class="switch">
                                    <input type="checkbox" id="matchOnlyToggle" checked onchange="refreshAuditTable()">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-auto scroll-style flex-grow">
                        <table class="w-full text-left border-separate border-spacing-0">
                            <thead class="sticky top-0 z-20 bg-white">
                                <tr>
                                    <th class="p-5 text-xs font-black text-slate-400 border-b uppercase">動作</th>
                                    <th class="p-5 text-xs font-black text-slate-400 border-b uppercase">製程 / 設備</th>
                                    <th class="p-5 text-xs font-black text-slate-500 border-b uppercase text-blue-600">執行時間</th>
                                    <th class="p-5 text-xs font-black text-slate-400 border-b uppercase text-center">數量</th>
                                    <th class="p-5 text-xs font-black text-slate-400 border-b uppercase">操作員</th>
                                </tr>
                            </thead>
                            <tbody id="auditTableBody" class="divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        let rawEff = [];
        let rawHist = [];
        let masterData = []; 
        let selectedDates = new Set();
        let status = { eff: false, hist: false };
        let currentSelectedMaster = null;

        function handleFileUpload(type) {
            const input = document.getElementById(type === 'eff' ? 'fileEff' : 'fileHist');
            const label = document.getElementById(type === 'eff' ? 'labelEff' : 'labelHist');
            const zone = document.getElementById(type === 'eff' ? 'zoneEff' : 'zoneHist');
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                const callback = (parsed) => {
                    if (type === 'eff') rawEff = parsed; else rawHist = parsed;
                    status[type] = true;
                    label.innerText = file.name;
                    zone.classList.add('success');
                    checkReady();
                };
                if (file.name.endsWith('.csv')) {
                    Papa.parse(data, { header: true, skipEmptyLines: true, complete: (res) => callback(res.data) });
                } else {
                    const wb = XLSX.read(data, { type: 'binary' });
                    callback(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                }
            };
            if (file.name.endsWith('.csv')) reader.readAsText(file); else reader.readAsBinaryString(file);
        }

        function checkReady() {
            if (status.eff && status.hist) document.getElementById('btnAnalyze').disabled = false;
        }

        function parseEfficiency(val) {
            if (!val) return 0;
            let n = typeof val === 'string' ? parseFloat(val.replace('%', '')) : val;
            if (n > 0 && n <= 2 && !String(val).includes('%')) n *= 100;
            return n || 0;
        }

        function startAnalysis() {
            masterData = rawEff.filter(d => {
                const woPrefix = String(d.工單編號 || '').substring(0, 4);
                const isAssemblyWO = woPrefix === 'GE31' || woPrefix === 'DE31';
                const isAssemblyProcess = String(d.製程 || '').includes('組裝');
                return !isAssemblyWO && !isAssemblyProcess;
            }).map((d, i) => {
                const startDt = d.實際生產日 ? d.實際生產日.trim() : null;
                const finishDt = d.實際完成日 ? d.實際完成日.trim() : null;
                const dateKey = d.實際完成日 ? d.實際完成日.split(' ')[0] : 'N/A';
                return {
                    ...d,
                    id: i,
                    effVal: parseEfficiency(d.產能效率),
                    isAnomaly: parseEfficiency(d.產能效率) > 100,
                    startDt,
                    finishDt,
                    dateKey
                };
            }).sort((a, b) => b.effVal - a.effVal);

            setupDateFilter();
            document.getElementById('opFilterSection').classList.remove('hidden');
            renderRankingList();
        }

        function setupDateFilter() {
            const dateSection = document.getElementById('dateFilterSection');
            const chips = document.getElementById('dateChips');
            const dates = [...new Set(masterData.map(d => d.dateKey))].sort().reverse();
            
            if (dates.length > 0) {
                dateSection.classList.remove('hidden');
                chips.innerHTML = '';
                dates.forEach(date => {
                    const btn = document.createElement('div');
                    btn.className = 'filter-chip';
                    btn.innerText = date;
                    btn.onclick = () => {
                        if (selectedDates.has(date)) selectedDates.delete(date);
                        else selectedDates.add(date);
                        btn.classList.toggle('active');
                        renderRankingList();
                    };
                    chips.appendChild(btn);
                });
            }
        }

        function renderRankingList() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const opQuery = document.getElementById('globalOpSearch').value.toLowerCase();
            const list = document.getElementById('rankingList');
            list.innerHTML = '';

            let operatorWOs = new Set();
            if (opQuery) {
                rawHist.forEach(log => {
                    if (String(log.操作員).toLowerCase().includes(opQuery)) {
                        operatorWOs.add(String(log.工單編號));
                    }
                });
            }

            const filtered = masterData.filter(item => {
                const matchSearch = String(item.工單編號).toLowerCase().includes(query) || 
                                    String(item.產品名稱).toLowerCase().includes(query) ||
                                    String(item.產品編號).toLowerCase().includes(query);
                const matchDate = selectedDates.size === 0 || selectedDates.has(item.dateKey);
                const matchOperator = opQuery === '' || operatorWOs.has(String(item.工單編號));
                return matchSearch && matchDate && matchOperator;
            });

            if (filtered.length === 0) {
                list.innerHTML = `<div class="p-10 text-center text-slate-400 font-bold">找不到符合條件的工單</div>`;
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                const isActive = currentSelectedMaster?.id === item.id;
                card.className = `ranking-item card-main p-6 cursor-pointer relative ${item.isAnomaly ? 'is-anomaly' : ''} ${isActive ? 'active' : ''}`;
                card.onclick = () => selectMaster(item, card);
                card.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="min-w-0 pr-4">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-xs font-black text-slate-400 metric-font">${item.工單編號}</span>
                                ${item.isAnomaly ? '<span class="bg-red-600 text-white text-[8px] px-1.5 py-0.5 rounded font-black uppercase">Anomaly</span>' : ''}
                            </div>
                            <h4 class="text-lg font-black text-slate-800 truncate mb-1">${item.產品名稱 || '---'}</h4>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-tight">完成日: ${item.實際完成日 || 'N/A'}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-black metric-font ${item.isAnomaly ? 'text-red-600' : 'text-blue-600'}">${item.effVal.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
                list.appendChild(card);
            });
        }

        function selectMaster(item, element) {
            document.querySelectorAll('.ranking-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            currentSelectedMaster = item;
            
            document.getElementById('auditHeader').style.opacity = '1';
            document.getElementById('activeWO').innerText = item.工單編號;
            document.getElementById('activeProd').innerText = item.產品名稱 || 'Unknown';
            document.getElementById('activeProdID').innerText = item.產品編號 || 'N/A';
            document.getElementById('activeEff').innerText = `${item.effVal.toFixed(1)}%`;
            document.getElementById('activeEff').className = `text-huge font-black metric-font ${item.isAnomaly ? 'text-red-600' : 'text-blue-600'}`;
            
            // 恢復時間顯示
            document.getElementById('targetStartTime').innerText = item.實際生產日 || 'N/A';
            document.getElementById('targetFinishTime').innerText = item.實際完成日 || 'N/A';

            refreshAuditTable();
        }

        function refreshAuditTable() {
            if (!currentSelectedMaster) return;
            const master = currentSelectedMaster;
            const matchOnly = document.getElementById('matchOnlyToggle').checked;
            // 取得左側輸入的操作員名稱
            const opQuery = document.getElementById('globalOpSearch').value.trim().toLowerCase();
            const tbody = document.getElementById('auditTableBody');
            tbody.innerHTML = '';

            const expectedStart = master.startDt;
            const expectedFinish = master.finishDt;

            // 1. 取得該工單所有紀錄
            const logs = rawHist.filter(d => 
                String(d.工單編號) === String(master.工單編號) && 
                !String(d.操作動作).includes('撤銷')
            ).sort((a, b) => new Date(a.執行時間) - new Date(b.執行時間));

            // 2. 標記邏輯：進站時間等於生產日、出站時間等於完成日 (精確比對)
            // 考慮到秒數可能會有系統延遲，我們用字串前 16 位比對 (到分鐘)，或者使用非常小的 tolerance (1秒)
            // 為了嚴謹依照指示 "實際生產時間=進站"，我們嘗試比對字串
            
            let processed = logs.map(l => {
                const logTimeStr = l.執行時間 ? l.執行時間.trim() : '';
                let isTimeMatched = false;
                
                // 比對邏輯
                if (l.操作動作 === '進站' && expectedStart) {
                    // 嘗試完全字串相等，或者時間戳記相差極小 (例如 < 2000ms)
                    if (logTimeStr === expectedStart) isTimeMatched = true;
                    else {
                        const t1 = new Date(logTimeStr).getTime();
                        const t2 = new Date(expectedStart).getTime();
                        if (Math.abs(t1 - t2) < 2000) isTimeMatched = true; 
                    }
                } else if (l.操作動作 === '出站' && expectedFinish) {
                    if (logTimeStr === expectedFinish) isTimeMatched = true;
                    else {
                        const t1 = new Date(logTimeStr).getTime();
                        const t2 = new Date(expectedFinish).getTime();
                        if (Math.abs(t1 - t2) < 2000) isTimeMatched = true;
                    }
                }
                
                return { ...l, isTimeMatched };
            });

            // 反轉順序以顯示最新在最上 (但如果是成對，通常想看 進 -> 出)
            // 這裡顯示列表，通常依時間倒序
            processed.reverse().forEach(log => {
                if (matchOnly && !log.isTimeMatched) return;
                
                const tr = document.createElement('tr');
                tr.className = log.isTimeMatched ? 'time-match-highlight' : 'hover:bg-slate-50';
                
                // 操作員高亮邏輯
                let operatorHtml = log.操作員 || '--';
                if (opQuery && String(operatorHtml).toLowerCase().includes(opQuery)) {
                    operatorHtml = `<span class="highlight-text">${operatorHtml}</span>`;
                }

                tr.innerHTML = `
                    <td class="p-5">
                        <span class="px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-widest ${log.操作動作 === '出站' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}">
                            ${log.操作動作}
                        </span>
                    </td>
                    <td class="p-5">
                        <div class="font-black text-slate-800 text-sm">${log.製程 || '--'}</div>
                        <div class="text-[9px] text-slate-400 font-bold">${log.設備 || '--'}</div>
                    </td>
                    <td class="p-5">
                        <div class="metric-font font-black text-base ${log.isTimeMatched ? 'text-blue-700' : 'text-slate-500'}">${log.執行時間}</div>
                        ${log.isTimeMatched ? `<div class="text-[8px] font-black text-amber-600 mt-0.5 uppercase tracking-tighter">吻合 (${log.操作動作 === '進站' ? '生產' : '完成'})</div>` : ''}
                    </td>
                    <td class="p-5 text-center font-black text-slate-800 text-lg">${log.數量 || 0}</td>
                    <td class="p-5 font-bold text-slate-700 text-xs">${operatorHtml}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>
